<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">


    <!-- Add sequences for ids autoincrement -->
    <changeSet author="darko" id="1" dbms="postgresql">
        <createSequence sequenceName="real_estates_property_id_seq" startValue="1" incrementBy="1"/>
    </changeSet>
    
    <changeSet author="darko" id="2" dbms="postgresql">
        <sql>
            <![CDATA[
            ALTER TABLE real_estates
            ALTER COLUMN property_id SET DEFAULT nextval('real_estates_property_id_seq');
            ]]>
        </sql>
    </changeSet>
    
    <changeSet author="darko" id="3">
    	<sql>
        	<![CDATA[
        	SELECT setval('real_estates_property_id_seq', (SELECT MAX(property_id) FROM real_estates));
        	]]>
	    </sql>
	</changeSet>
	
    
    <changeSet author="darko" id="4" dbms="postgresql">
        <createSequence sequenceName="user_id_seq" startValue="1" incrementBy="1"/>
    </changeSet>
    
    <changeSet author="darko" id="5" dbms="postgresql">
        <sql>
            <![CDATA[
            ALTER TABLE users
            ALTER COLUMN id SET DEFAULT nextval('user_id_seq');
            ]]>
        </sql>
    </changeSet>
    
    <changeSet author="darko" id="6">
    	<sql>
        	<![CDATA[
        	SELECT setval('user_id_seq', (SELECT MAX(id) FROM users));
        	]]>
	    </sql>
	</changeSet>



	<changeSet author="darko" id="7" dbms="postgresql">
        <createSequence sequenceName="role_id_seq" startValue="1" incrementBy="1"/>
    </changeSet>
    
    <changeSet author="darko" id="8" dbms="postgresql">
        <sql>
            <![CDATA[
            ALTER TABLE roles
            ALTER COLUMN id SET DEFAULT nextval('role_id_seq');
            ]]>
        </sql>
    </changeSet>
    
    <changeSet author="darko" id="9">
    	<sql>
        	<![CDATA[
        	SELECT setval('role_id_seq', (SELECT MAX(id) FROM roles));
        	]]>
	    </sql>
	</changeSet>

    <changeSet id="10" author="darko" dbms="postgresql">
    	<dropColumn tableName="users" columnName="username"/>
    		<addColumn tableName="users">
    			<column name="email" type="varchar(255)"/>
    		</addColumn>
    </changeSet>
    
    <changeSet id="11" author="darko" dbms="postgresql">
        <addColumn tableName="real_estates">
            <column name="listing_type" type="varchar(20)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="12" author="darko">
        <createTable tableName="real_estate_images">
            <column name="property_id" type="BIGINT">
                <constraints nullable="false" referencedTableName="real_estates" referencedColumnNames="property_id"/>
            </column>
            <column name="image_url" type="VARCHAR(512)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="13" author="darko">
        <addForeignKeyConstraint baseTableName="real_estate_images"
                               baseColumnNames="property_id"
                               constraintName="fk_real_estate_images_property"
                               referencedTableName="real_estates"
                               referencedColumnNames="property_id"
                               onDelete="CASCADE"/>
    </changeSet>
    
    <changeSet id="14" author="darko" dbms="postgresql">
        <createIndex tableName="real_estate_images" indexName="idx_real_estate_images_property_id">
            <column name="property_id"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="15" author="darko" dbms="postgresql">
    <addColumn tableName="real_estates">
        <column name="user_id" type="BIGINT"/>
    </addColumn>
    
    <addForeignKeyConstraint 
        baseTableName="real_estates"
        baseColumnNames="user_id"
        constraintName="fk_real_estate_user"
        referencedTableName="users"
        referencedColumnNames="id"/>
</changeSet>


</databaseChangeLog>
